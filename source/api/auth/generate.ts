import { NextFunction, Request, Response } from "express"
import * as jwt from "jsonwebtoken"

import { isString } from "util"
import { PERIL_INTEGRATION_ID, PRIVATE_GITHUB_SIGNING_KEY } from "../../globals"

// A JWT is a special type of string
type JWT = string

// The Decoded JWT data
export interface PerilJWT {
  exp: number
  iat: number
  iss: string[]
  data: {
    gh_orgs: string[]
    user: PerilOAuthUser
  }
}

export interface PerilOAuthUser {
  name: string
  github: {}
}

/**
 * Takes a user with details from GH Oauth and generates
 * a JWT which can be used to make authenticated requests
 * against Peril.
 */
export const createPerilJWT = (user: PerilOAuthUser, gitHubOrgs: string[]): JWT => {
  const now = Math.round(new Date().getTime() / 1000)
  const expires = now + 60
  const keyContent = PRIVATE_GITHUB_SIGNING_KEY
  const payload: PerilJWT = {
    exp: expires,
    iat: now,
    iss: ["peril", PERIL_INTEGRATION_ID],
    data: {
      gh_orgs: gitHubOrgs,
      user,
    },
  }

  return jwt.sign(payload, keyContent, { algorithm: "RS256" })
}

/**
 * Decode and verifies a JWT generated by createPerilJWT above
 * @param token the JWT
 */
export const getDetailsFromPerilJWT = (token: JWT) =>
  new Promise<PerilJWT>((res, rej) => {
    const options = { algorithms: ["RS256"] }
    jwt.verify(token, PRIVATE_GITHUB_SIGNING_KEY, options, (err, decoded) => {
      if (err) {
        rej(err)
      } else {
        if (isString(decoded)) {
          res(JSON.parse(decoded as string))
        } else {
          res(decoded as any)
        }
      }
    })
  })

export const redirectForGHOauth = (_: Request, __: Response, ___: NextFunction) => {
  // Do a GH Oauth
  // Send back to the route for the auth token
}

export const generateAuthToken = (_: Request, __: Response, ___: NextFunction) => {
  // Receive the GH auth token, then generate enough info for a Peril User & JWT
  // Set that to the user's session, and then redirect to the admin page
}
